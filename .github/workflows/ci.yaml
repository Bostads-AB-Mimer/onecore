name: CI

on:
  pull_request:
  push:
    branches: ["**"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-matrix.outputs.matrix }}
      cache-key: ${{ steps.cache.outputs.key }}
      cache-path: ${{ steps.cache.outputs.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node + caches + npm ci (only on cache miss)
      - name: Setup npm
        uses: ./.github/actions/npm-setup

      # Compute a cache key that changes when lib sources / tsconfig / lockfile change
      - name: Compute cache key & path
        id: cache
        run: |
          # Key
          echo "key=${{ runner.os }}-node-20-dist-${{ hashFiles('libs/**/src/**','packages/**/src/**','**/tsconfig*.json','**/package-lock.json') }}" >> $GITHUB_OUTPUT

          # Path
          {
            echo 'path<<EOF'
            echo 'libs/**/dist'
            echo 'node_modules/.prisma'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      # Try to restore dist; on cache miss, we'll build and generate here once, and store
      # the results to cache upon completion
      - name: Restore prepare cache
        id: restore-prepare-cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache.outputs.path }}
          key: ${{ steps.cache.outputs.key }}
          
      # Run generate:static once for downstrea jobs, unless cached
      - name: Build libs
        if: steps.restore-libs-cache.outputs.cache-hit != 'true'
        run: npm run generate:static

      # Build shared libs once for downstream jobs that need compiled deps
      - name: Build libs
        if: steps.restore-libs-cache.outputs.cache-hit != 'true'
        run: npm run build:libs

      # Read build matrix (later used to run jobs in parallel, per package)
      - name: Read build matrix
        id: read-matrix
        shell: bash
        run: |
          MATRIX=$(cat ./.github/build.matrix.json | jq -c .)
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT

  lint:
    name: ${{ matrix.package }} - Lint
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/npm-setup

      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run Lint
        run: npm run --workspace ${{ matrix.package }} lint

  prettier:
    name: ${{ matrix.package }} - Prettier check
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/npm-setup

      - name: Run Prettier
        run: npm run --workspace ${{ matrix.package }} prettier

  typecheck:
    name: ${{ matrix.package }} - Typecheck
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Setup
        uses: ./.github/actions/npm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run Typecheck
        run: npm run --workspace ${{ matrix.package }} typecheck

  build:
    name: ${{ matrix.package }} - Build
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Setup
        uses: ./.github/actions/npm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Build
        run: npm run --workspace ${{ matrix.package }} build


  test:
    name: ${{ matrix.package }} - Run Tests
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      - name: Setup
        uses: ./.github/actions/npm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run tests
        run: npm run --workspace "${{ matrix.package }}" test
