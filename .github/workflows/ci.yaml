name: CI

on:
  pull_request:
  push:
    branches: ["**"]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run CI workflow on?"
        required: true
        default: "main"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-matrix.outputs.matrix }}
      cache-key: ${{ steps.cache.outputs.key }}
      cache-path: ${{ steps.cache.outputs.path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      # Node + caches + pnpm install (only on cache miss)
      - name: Setup pnpm
        uses: ./.github/actions/pnpm-setup

      # Compute a cache key that changes when lib sources / tsconfig / lockfile change
      - name: Compute cache key & path
        id: cache
        run: |
          # Key (hash sources + tsconfigs + lockfile)
          echo "key=${{ runner.os }}-node-20-dist-${{ hashFiles('libs/**/src/**','packages/**/src/**','**/tsconfig*.json','**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

          # Path (things we want to reuse later)
          {
            echo 'path<<EOF'
            echo 'libs/**/dist'
            echo 'node_modules/.prisma'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      # Try to restore dist; on cache miss, we'll build and generate here once, and store
      # the results to cache upon completion
      - name: Restore prepare cache
        id: restore-prepare-cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache.outputs.path }}
          key: ${{ steps.cache.outputs.key }}
          
      # Run generate:static once for downstreams jobs, unless cached
      - name: Run generate:static
        if: steps.restore-prepare-cache.outputs.cache-hit != 'true'
        run: pnpm run generate:static

      # Build shared libs once for downstreams jobs that need compiled deps
      - name: Build libs
        if: steps.restore-prepare-cache.outputs.cache-hit != 'true'
        run: pnpm run build:libs

      # Read build matrix (later used to run jobs in parallel, per package)
      - name: Read build matrix
        id: read-matrix
        shell: bash
        run: |
          MATRIX=$(cat ./.github/build.matrix.json | jq -c .)
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT

      # Emit ref/branch info for dependent workflows triggered with workflow_run
      - name: Emit ref/branch
        run: |
          echo "github.ref: ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "head_branch: ${{ github.event.workflow_run.head_branch }}"
          echo "head_sha: ${{ github.event.workflow_run.head_sha }}"

  lint:
    name: ${{ matrix.package }} - Lint
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup
        uses: ./.github/actions/pnpm-setup

      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run Lint
        run: pnpm run --filter ${{ matrix.package }} lint

  prettier:
    name: ${{ matrix.package }} - Prettier check
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup
        uses: ./.github/actions/pnpm-setup

      - name: Run Prettier
        run: pnpm run --filter ${{ matrix.package }} prettier

  typecheck:
    name: ${{ matrix.package }} - Typecheck
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
 
      - name: Setup
        uses: ./.github/actions/pnpm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run Typecheck
        run: pnpm run --filter ${{ matrix.package }} typecheck

  build:
    name: ${{ matrix.package }} - Build
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
 
      - name: Setup
        uses: ./.github/actions/pnpm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Build
        run: pnpm run --filter ${{ matrix.package }} build


  test:
    name: ${{ matrix.package }} - Run Tests
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
 
      - name: Setup
        uses: ./.github/actions/pnpm-setup
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ${{ needs.prepare.outputs.cache-path }}
          key: ${{ needs.prepare.outputs.cache-key }}

      - name: Run tests
        run: pnpm run --filter "${{ matrix.package }}" test
